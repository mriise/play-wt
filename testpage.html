<body>
    <script>
        const ADDR_NAME = "wtAddress";
        const CERTHASH_NAME = "wtCerthash";

        window.onload = () => {
            // load query param into fields
            (new URL(window.location.href)).searchParams.forEach((k, v) => document.getElementById(v).value = k)
        }


        let webtransportClick = async () => {
            let wtAddress = document.getElementById(ADDR_NAME).value;
            let wtCerthash = document.getElementById(CERTHASH_NAME).value;

            let certhash = Uint8Array.from(atob(wtCerthash), c => c.charCodeAt(0));
            let transport = new WebTransport(wtAddress, {
                    serverCertificateHashes: [
                    {
                        algorithm: "sha-256",
                        value: certhash.buffer
                    }
                ]
            });

            console.log(transport)
            await transport.ready;
    
            // Create a bidirectional stream
            let stream = await transport.createBidirectionalStream();

            readFromIncomingStream(stream.readable, 0);

            let writer = stream.writable.getWriter();

            let encoder = new TextEncoder('utf-8');
            let rawData = "ping";
            let data = encoder.encode(rawData);
            await writer.write(data)
            await writer.close();

            // Send data from the client to the server
            // await stream.writable.getWriter().write(new TextEncoder().encode("ping"));
    
            // Read data reply from the server
            // let data = await stream.readable.getReader().read();
            // console.log(data);
        }


        async function readFromIncomingStream(stream, number) {
            let decoder = new TextDecoderStream('utf-8');
            let reader = stream.pipeThrough(decoder).getReader();
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) {
                        console.log('Stream #' + number + ' closed');
                        return;
                    }
                    let data = value;
                    console.log('Received data on stream #' + number + ': ' + data);
                }
            } catch (e) {
                console.error(
                    'Error while reading from stream #' + number + ': ' + e, 'error');
            }
        }

        let shareClick = async () => {
            let shareURL = new URL(window.location.href);
            shareURL.search = "";

            shareURL.searchParams.append(ADDR_NAME, document.getElementById(ADDR_NAME).value);
            shareURL.searchParams.append(CERTHASH_NAME, document.getElementById(CERTHASH_NAME).value);

            navigator.clipboard.writeText(shareURL.href);
            document.getElementById("shareButton").innerText = "copied!"

            await new Promise(r => setTimeout(r, 2000));
            document.getElementById("shareButton").innerText = "share"
        }
        
    </script>

    <form onsubmit="return false">
        <input type="text" id="wtAddress" placeholder="Address" value="https://127.0.0.1:4433">
        <input type="text" id="wtCerthash" placeholder="Certhash" style="width: 350px;">
        <button onclick="webtransportClick()">connect</button>
        <button onclick="shareClick()" id="shareButton">share</button>
    </form>
    
</body>